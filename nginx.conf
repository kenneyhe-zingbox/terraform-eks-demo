upstream api_servers {
        server zcapi:9030 max_fails=3 fail_timeout=30;
        # list more instances for connector cluster here...

        # Upstream check settings
        check interval=3000 rise=2 fall=5 timeout=1000 type=tcp port=9030;
        check_keepalive_requests 100;
}

upstream con_servers {
        server zccon:9031 max_fails=3 fail_timeout=30;
        # list more instances for connector cluster here...

        # Upstream check settings
        check interval=3000 rise=2 fall=5 timeout=1000 type=tcp port=9031;
        check_keepalive_requests 100;
}

upstream auth_servers {
        server zcauth:9032 max_fails=3 fail_timeout=30;
        # list more instances for connector cluster here...

        # Upstream check settings
        check interval=3000 rise=2 fall=5 timeout=1000 type=tcp port=9032;
        check_keepalive_requests 100;

}

upstream proxy_servers {
        # list more instances for connector cluster here...
        server zcapiproxy:9033 max_fails=3 fail_timeout=30;

        # Upstream check settings
        keepalive 32;
        check interval=3000 rise=2 fall=5 timeout=1000 type=tcp port=9033;
        check_keepalive_requests 100;

}


#upstream fe_servers {
#        server localhost:9090 max_fails=3 fail_timeout=30;
#        # list more instances for connector cluster here...
#
#        # Upstream check settings
#        check interval=3000 rise=2 fall=5 timeout=1000 type=tcp port=9090;
#        check_keepalive_requests 100;
#
#}

server {
    listen      80;
    server_name     enterprise.zingbox.com;
    return      301 https://$host$request_uri;
}

server {
        listen 443 ssl;

        # Make site accessible from http://localhost/
        server_name localhost;

        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;

        root /usr/local/nginx/html;
   

        rewrite ^/search.* / last;
        rewrite ^/monitor.* / last;
        rewrite ^/alerts.* / last;
        rewrite ^/useraccounts.* / last;
        rewrite ^/tenantaccounts.* / last;
        rewrite ^/detail.* / last;
        rewrite ^/login.* / last;
        rewrite ^/register.* / last;
        rewrite ^/administration.* / last;
        rewrite ^/protocol.* / last;

        # onboarding FE
        rewrite ^/request_tryout / last;
        rewrite ^/register.* / last;

        rewrite ^/requestusers /404 last;
        rewrite ^/adminindex.html /404 last;
        rewrite ^/v0.3/api/onboarding/sendRegisterEmail /404 last;
        rewrite ^/v0.3/api/onboarding/createTenant /404 last;
        rewrite ^/v0.3/api/onboarding/getImageOrder /404 last;
        rewrite ^/v0.3/api/onboarding/tenantImageUrl /404 last;
        rewrite ^/v0.3/api/onboarding/changeTrialUserStatus /404 last;
        rewrite ^/v0.3/api/onboarding/listTrialUsers /404 last;
        rewrite ^/topology.* / last;

        
        location / {
                root   html;
                index  index.html index.htm;
        }

        location /404 {
                return 404;
        }

        location /v0.3/con {
                proxy_pass https://zccon:9031/v0.3/con;
                proxy_next_upstream     error timeout http_500;
                proxy_connect_timeout   2;
                proxy_redirect off;
                proxy_buffering off;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /v0.3/zauth {
                proxy_pass https://zcauth:9032/v0.3/zauth;
                proxy_next_upstream     error timeout http_500;
                proxy_connect_timeout   2;
                proxy_redirect off;
                proxy_buffering off;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /v0.3/api { # New routing for API
                proxy_pass https://zcapi:9030/v0.3/api;
                proxy_next_upstream     error timeout http_500;
                proxy_connect_timeout   2;
                proxy_redirect off;
                proxy_buffering off;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /wss/connect {
                proxy_pass https://zccon:9031/wss/connect;
                proxy_next_upstream     error timeout http_500;
                proxy_connect_timeout   2;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
        }

    location /v0.3/proxy { # New routing for API
        proxy_pass https://zcapiproxy:9033/v0.3/proxy;
        proxy_next_upstream     error timeout;
        proxy_http_version      1.1;
        proxy_set_header        Connection "";
        proxy_connect_timeout   2;
        proxy_redirect off;
        proxy_buffering off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cookie_path / "/; secure; HttpOnly";
    }
 
        location /svc_status {
                stub_status on;
                access_log off;
        }

        location /status {
                check_status;
                access_log off;
        }

        location /state {
                alias /usr/local/nginx/html/state;
                access_log off;
        }
}
